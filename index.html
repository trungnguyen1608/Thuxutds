<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOOL SMS FREE ‚Äî Demo (MR TRUNG VIP)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;margin:0;padding:24px;display:flex;justify-content:center}
    .container{width:100%;max-width:980px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.06);overflow:hidden}
    header{display:flex;flex-direction:column;align-items:stretch}
    .topline{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(90deg,#0b6efd,#0658d9);color:#fff}
    .logo{font-weight:700}
    .vip-banner{background:#ffefc9;color:#b35900;font-weight:800;text-align:center;border-top:4px solid #ffd58a;padding:10px;font-size:16px}
    main{padding:20px}
    .card{background:#fff;padding:14px;margin-bottom:12px;border-radius:10px;border:1px solid #f1f5f9;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    label{display:block;margin-top:10px;font-weight:600}
    input,textarea,button{width:100%;padding:10px;margin-top:6px;border:1px solid #e6eefb;border-radius:8px;font-size:14px}
    button.primary{background:#ff6b35;color:#fff;border:0;cursor:pointer;font-weight:800}
    button[disabled]{background:#ccc;cursor:not-allowed}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tabs button{width:auto;padding:8px 12px;border-radius:8px;background:#f3f7ff;border:1px solid #e6efff;cursor:pointer}
    .hidden{display:none}
    .small{font-size:13px;color:#6b7280;margin-top:8px}
    .alert{color:red;font-weight:bold;margin-top:8px}
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 6px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #toolCountdown { font-size: 22px; font-weight: bold; color: #ff6b35; margin-top: 10px; letter-spacing: 2px; font-family: 'Courier New', monospace; background: #fff3e6; padding: 8px 12px; border-radius: 8px; display: inline-block; }
    .progress { margin-top: 12px; font-size: 14px; color:#0b6efd }
    .btn-sim { margin-top:8px; background:#0658d9; color:#fff; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; }
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .ip-history { white-space:pre-wrap; font-family:monospace; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="topline">
        <div class="logo">TOOL SMS FREE</div>
        <div style="color:#fff;font-weight:700">Zalo Admin: <span style="background:#fff;color:#0b6efd;padding:6px 10px;border-radius:6px">0869234153</span></div>
      </div>
      <div class="vip-banner" id="vipBanner">üè∑Ô∏è MR TRUNG VIP ‚Äî Banner</div>
    </header>

    <main>
      <div class="card">
        <div class="tabs">
          <button id="tabLogin">ƒêƒÉng nh·∫≠p</button>
          <button id="tabRegister">ƒêƒÉng k√Ω</button>
          <button id="tabTool" class="hidden">Tool SMS</button>
          <button id="tabAdmin" class="hidden">Admin</button>
        </div>

        <!-- Tool -->
        <div id="boxTool" class="hidden">
          <h3>G·ª≠i SMS (Demo)</h3>
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input id="phone" type="tel" placeholder="0899...">
          <label>N·ªôi dung (m·∫´u h·ª£p ph√°p demo)</label>
          <textarea id="message" rows="4">[MR TRUNG VIP] Khuy·∫øn m√£i ƒë·∫∑c bi·ªát h√¥m nay! Nh·∫≠n ∆∞u ƒë√£i X% khi mua h√†ng. Tr·∫£ l·ªùi STOP ƒë·ªÉ h·ªßy nh·∫≠n tin.</textarea>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="sendDemo" class="primary" style="flex:1">G·ª≠i (Demo)</button>
            <button id="showPhone" style="flex:1">G·ªçi / Hi·ªán s·ªë</button>
          </div>

          <div id="toolMsg" class="small"></div>
          <div id="toolAlert" class="alert hidden">‚è∞ Tool ch·ªâ ho·∫°t ƒë·ªông t·ª´ 19h‚Äì24h</div>

          <div style="margin-top:10px">
            <div id="toolCountdown"></div>
            <div id="toolNote" class="small" style="color:#6b7280;margin-top:4px"></div>

            <div id="bulkArea" style="margin-top:10px">
              <button class="btn-sim" id="simulate50">M√¥ ph·ªèng g·ª≠i 50 tin (demo)</button>
              <button class="btn-sim" id="simulate100">M√¥ ph·ªèng g·ª≠i 100 tin (demo)</button>
              <div id="bulkProgress" class="progress"></div>
            </div>
          </div>
        </div>

        <!-- Login -->
        <div id="boxLogin">
          <h3>ƒêƒÉng nh·∫≠p</h3>
          <label>Email</label><input id="loginEmail" type="email">
          <label>M·∫≠t kh·∫©u</label><input id="loginPassword" type="password">
          <button id="btnLogin" class="primary">ƒêƒÉng nh·∫≠p</button>
          <div id="loginMsg" class="small"></div>
        </div>

        <!-- Register -->
        <div id="boxRegister" class="hidden">
          <h3>ƒêƒÉng k√Ω</h3>
          <label>T√™n</label><input id="regName" type="text">
          <label>Email</label><input id="regEmail" type="email">
          <label>M·∫≠t kh·∫©u</label><input id="regPassword" type="password">
          <label>SƒêT (t√πy ch·ªçn)</label><input id="regPhone" type="tel">
          <button id="btnRegister" class="primary">ƒêƒÉng k√Ω</button>
          <div id="regMsg" class="small"></div>
        </div>

        <!-- Admin -->
        <div id="boxAdmin" class="hidden">
          <h3>Qu·∫£n l√Ω Members</h3>
          <button id="refreshMembers">T·∫£i danh s√°ch</button>
          <div id="membersArea" style="margin-top:10px"></div>

          <div style="margin-top:10px">
            <button id="viewSimLogs" class="btn-sim">Xem log m√¥ ph·ªèng</button>
            <button id="downloadSimLogs" class="btn-sim">T·∫£i log JSON</button>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
/* =================== HELPERS =================== */
const $ = id => document.getElementById(id);
const show = id => $(id).classList.remove('hidden');
const hide = id => $(id).classList.add('hidden');
const setMsg = (id,txt,color) => { const el=$(id); if(el){ el.textContent=txt; el.style.color=color||'black'; } };

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function saveUsers(u){ localStorage.setItem('users',JSON.stringify(u)); }

// Ensure default admin
if(!getUsers().some(u=>u.role==='admin')){
  const u = getUsers();
  u.push({id:'admin', name:'Admin', email:'admin@example.com', password:'admin123', role:'admin', blocked:false, lastIp:'-', ipHistory:[]});
  saveUsers(u);
}

/* =================== IP fetcher (public IP) =================== */
let lastFetchedIp = 'unknown';
function fetchMyIpOnce(){
  // fetch public IP (only for demo); failure is OK
  fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{
    if(d && d.ip){ lastFetchedIp = d.ip; }
  }).catch(()=>{ /* ignore */ });
}
fetchMyIpOnce();

/* =================== Auth & Tool logic =================== */
let currentUser = null;

// countdown & time
function updateCountdown(ms){
  const totalSec = Math.max(0, Math.floor(ms/1000));
  const h = String(Math.floor(totalSec/3600)).padStart(2,'0');
  const m = String(Math.floor((totalSec%3600)/60)).padStart(2,'0');
  const s = String(totalSec%60).padStart(2,'0');
  $('toolCountdown').textContent = `‚è≥ ${h}:${m}:${s}`;
}

function updateToolStatus(){
  const now = new Date();
  const hour = now.getHours();
  if(hour < 19){
    const target = new Date(); target.setHours(19,0,0,0);
    show('toolAlert'); $('sendDemo').setAttribute('disabled','true');
    updateCountdown(target - now); $('toolNote').textContent = "Tool s·∫Ω m·ªü v√†o l√∫c 19h h√¥m nay";
  } else if(hour >= 24){
    const target = new Date(); target.setDate(target.getDate()+1); target.setHours(19,0,0,0);
    show('toolAlert'); $('sendDemo').setAttribute('disabled','true');
    updateCountdown(target - now); $('toolNote').textContent = "Tool s·∫Ω m·ªü v√†o l√∫c 19h ng√†y mai";
  } else {
    hide('toolAlert'); $('sendDemo').removeAttribute('disabled'); $('toolCountdown').textContent=''; $('toolNote').textContent='';
  }
}

// Tabs
const tabs={login:'boxLogin', register:'boxRegister', tool:'boxTool', admin:'boxAdmin'};
function openTab(name){
  Object.values(tabs).forEach(id=>hide(id));
  if(name==='tool'){
    if(!currentUser){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); show(tabs.login); return; }
    show(tabs.tool);
    updateToolStatus();
  } else if(name==='admin'){
    if(currentUser?.role!=='admin'){ alert('Ch·ªâ Admin'); show(tabs.login); return; }
    show(tabs.admin); loadMembers();
  } else show(tabs[name]);
}
$('tabLogin').onclick=()=>openTab('login');
$('tabRegister').onclick=()=>openTab('register');
$('tabTool').onclick=()=>openTab('tool');
$('tabAdmin').onclick=()=>openTab('admin');
openTab('login');

/* =================== AUTH: register / login (store IP) =================== */
async function recordIpForUser(user){
  // ensure we have fetched IP; if not, try once more
  if(lastFetchedIp === 'unknown'){
    try {
      const r = await fetch('https://api.ipify.org?format=json');
      const j = await r.json();
      if(j.ip) lastFetchedIp = j.ip;
    } catch(e){}
  }
  const ip = lastFetchedIp || 'unknown';
  user.lastIp = ip;
  user.ipHistory = user.ipHistory || [];
  user.ipHistory.unshift({ip, time: new Date().toLocaleString()});
}

$('btnRegister').onclick = async ()=>{
  const name=$('regName').value.trim(), email=$('regEmail').value.trim(), pass=$('regPassword').value.trim(), phone=$('regPhone').value.trim();
  if(!name||!email||!pass){ setMsg('regMsg','Nh·∫≠p ƒë·ªß th√¥ng tin','red'); return; }
  let users=getUsers();
  if(users.some(u=>u.email===email)){ setMsg('regMsg','Email ƒë√£ t·ªìn t·∫°i','red'); return; }
  const newU = { id: Date.now()+'', name, email, password:pass, phone, role:'member', blocked:false, lastIp:'-', ipHistory:[] };
  await recordIpForUser(newU);
  users.push(newU); saveUsers(users);
  currentUser = newU;
  setMsg('regMsg','ƒêƒÉng k√Ω th√†nh c√¥ng','green');
  show('tabTool'); show('btnLogout'); if(newU.role==='admin') show('tabAdmin'); openTab('tool');
};

$('btnLogin').onclick = async ()=>{
  const email=$('loginEmail').value.trim(), pass=$('loginPassword').value.trim();
  let users=getUsers(); const user = users.find(u=>u.email===email);
  if(!user){ setMsg('loginMsg','Kh√¥ng t√¨m th·∫•y','red'); return; }
  if(user.blocked){ setMsg('loginMsg','T√†i kho·∫£n b·ªã ch·∫∑n','red'); return; }
  if(user.password!==pass){ setMsg('loginMsg','Sai m·∫≠t kh·∫©u','red'); return; }
  // record ip on login
  await recordIpForUser(user);
  // persist update
  const others = users.filter(u=>u.id!==user.id); others.push(user); saveUsers(others);
  currentUser = user;
  setMsg('loginMsg','ƒêƒÉng nh·∫≠p th√†nh c√¥ng (IP: '+user.lastIp+')','green');
  show('tabTool'); show('btnLogout'); if(user.role==='admin') show('tabAdmin'); openTab('tool');
};

$('btnLogout').onclick = ()=>{ currentUser=null; hide('tabTool'); hide('tabAdmin'); hide('btnLogout'); openTab('login'); };

/* =================== Tool send (demo) + spinner =================== */
$('sendDemo').onclick = ()=>{
  const phone=$('phone').value.trim(), msg=$('message').value.trim();
  if(!phone||!msg){ setMsg('toolMsg','Nh·∫≠p phone & n·ªôi dung','red'); return; }
  const btn=$('sendDemo'); btn.innerHTML='<span class="loading-spinner"></span>ƒêang g·ª≠i...'; btn.setAttribute('disabled','true'); setMsg('toolMsg','ƒêang x·ª≠ l√Ω...','blue');
  setTimeout(()=>{
    btn.textContent='G·ª≠i (Demo)'; updateToolStatus();
    // also append a simulated single action to sim_actions log
    const actions = JSON.parse(localStorage.getItem('sim_actions')||'[]');
    actions.unshift({ id:'sim_'+Date.now(), to:phone, message:msg, from: currentUser? (currentUser.email||currentUser.name) : 'guest', timestamp:new Date().toISOString(), ip: currentUser?.lastIp || lastFetchedIp || 'unknown', status:'simulated' });
    localStorage.setItem('sim_actions', JSON.stringify(actions));
    setMsg('toolMsg','‚úÖ Demo g·ª≠i t·ªõi '+phone,'green');
  }, 1500);
};

$('showPhone').onclick = ()=>{ const phone=$('phone').value.trim(); if(!phone){ setMsg('toolMsg','Nh·∫≠p phone','red'); return; } alert('S·ªë: '+phone); setMsg('toolMsg','Hi·ªán s·ªë: '+phone,'green'); };

/* =================== Admin: members + IP history view =================== */
function loadMembers(){
  const users = getUsers();
  $('membersArea').innerHTML = '<table><tr><th>Name</th><th>Email</th><th>Phone</th><th>Last IP</th><th>Status</th><th>Action</th></tr>' +
    users.map(u => `<tr>
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td>${u.phone||'-'}</td>
      <td>${u.lastIp||'-'}</td>
      <td>${u.blocked?'<span style="color:red">Blocked</span>':'Active'}</td>
      <td>
        ${u.role!=='admin' ? '<button onclick="toggleBlock(\\''+u.id+'\\')">'+(u.blocked?'Unblock':'Block')+'</button>' : ''}
        <button onclick="showIpHistory(\\'${u.id}\\')">Xem IP</button>
      </td>
    </tr>`).join('') + '</table>';
}

window.toggleBlock = function(id){
  const users = getUsers();
  const u = users.find(x=>x.id===id);
  if(!u) return;
  u.blocked = !u.blocked;
  saveUsers(users);
  loadMembers();
};

window.showIpHistory = function(id){
  const users = getUsers();
  const u = users.find(x=>x.id===id);
  if(!u) return alert('Kh√¥ng t√¨m th·∫•y user');
  const hist = u.ipHistory||[];
  if(!hist.length) return alert('Ch∆∞a c√≥ IP history cho user n√†y.');
  const text = hist.map(h => `${h.time}  ‚Äî  ${h.ip}`).join('\n');
  // open popup
  const w = window.open('', '_blank');
  w.document.title = 'IP History - '+u.name;
  w.document.body.style.fontFamily = 'monospace';
  w.document.body.style.whiteSpace = 'pre-wrap';
  w.document.body.innerText = text;
};

/* =================== Simulate bulk send (safe demo) =================== */
function appendBulkProgress(txt){ const el=$('bulkProgress'); if(el) el.textContent = txt; }
async function simulateBulkSend(count=50, message=null){
  if(!currentUser){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  if(!confirm(`M√¥ ph·ªèng g·ª≠i ${count} tin (CH·ªà DEMO, KH√îNG G·ª¨I TH·ª∞C). Ti·∫øp t·ª•c?`)) return;
  const sendBtn=$('sendDemo'); const backup=sendBtn.innerHTML;
  sendBtn.innerHTML='<span class="loading-spinner"></span>ƒêang g·ª≠i h√†ng lo·∫°t...';
  sendBtn.setAttribute('disabled','true');
  appendBulkProgress(`B·∫Øt ƒë·∫ßu m√¥ ph·ªèng ${count} tin...`);
  const targets = [];
  for(let i=0;i<count;i++) targets.push('0899xxxx'+String(i).padStart(3,'0'));
  const actions = JSON.parse(localStorage.getItem('sim_actions')||'[]');
  for(let i=0;i<targets.length;i++){
    await new Promise(r => setTimeout(r, 50 + Math.random()*150));
    const log = { id:'sim_'+Date.now()+'_'+i, to:targets[i], message: message || $('message').value, from: currentUser.email||currentUser.name, timestamp:new Date().toISOString(), ip: currentUser?.lastIp || lastFetchedIp || 'unknown', status:'simulated' };
    actions.unshift(log);
    localStorage.setItem('sim_actions', JSON.stringify(actions));
    appendBulkProgress(`ƒê√£ m√¥ ph·ªèng: ${i+1}/${targets.length} ‚Äî ${targets[i]}`);
  }
  sendBtn.innerHTML = backup; sendBtn.removeAttribute('disabled');
  appendBulkProgress(`Ho√†n t·∫•t m√¥ ph·ªèng ${targets.length} tin (KH√îNG G·ª¨I TH·ª∞C).`);
  alert('M√¥ ph·ªèng ho√†n t·∫•t. V√†o Admin -> Xem log m√¥ ph·ªèng ƒë·ªÉ ki·ªÉm tra.');
}

$('simulate50').onclick = ()=> simulateBulkSend(50);
$('simulate100').onclick = ()=> simulateBulkSend(100);

/* =================== Admin: view / download sim logs =================== */
$('viewSimLogs').onclick = ()=> {
  const a = JSON.parse(localStorage.getItem('sim_actions')||'[]');
  if(!a.length) return alert('Ch∆∞a c√≥ log m√¥ ph·ªèng.');
  const w = window.open('', '_blank'); w.document.title='Sim Logs'; w.document.body.style.whiteSpace='pre-wrap'; w.document.body.style.fontFamily='monospace';
  w.document.body.innerText = a.map(x=>`${x.timestamp} | ${x.from} -> ${x.to} | ${x.message} | IP:${x.ip}`).join('\n');
};
$('downloadSimLogs').onclick = ()=> {
  const data = localStorage.getItem('sim_actions')||'[]';
  const url = 'data:text/json;charset=utf-8,' + encodeURIComponent(data);
  const a = document.createElement('a'); a.href=url; a.download='sim_actions.json'; a.click();
};

/* =================== Utility: set custom message (call from console or add a button) =================== */
function setCustomMessage(text){
  const ta = $('message');
  if(ta) ta.value = text;
}

/* =================== Auto update countdown every second while tool visible =================== */
setInterval(()=>{ if(!$('boxTool').classList.contains('hidden')) updateToolStatus(); }, 1000);

/* =================== On page load: fetch IP, ensure UI defaults =================== */
fetchMyIpOnce();
</script>
</body>
</html>