<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOOL SMS FREE — Demo (Auth & Admin)</title>
  <style>
    /* styles rút gọn cho rõ ràng */
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;margin:0;padding:24px;display:flex;justify-content:center}
    .container{width:100%;max-width:980px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.06);overflow:hidden}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#0b6efd,#0658d9);color:#fff}
    header .logo{font-weight:700}
    main{display:flex;gap:20px;padding:20px;flex-wrap:wrap}
    .left{flex:1 1 420px;padding:12px}
    .right{flex:1 1 420px;padding:12px;border-left:1px solid #f0f0f0}
    .card{background:#fff;padding:14px;border-radius:10px;border:1px solid #f1f5f9;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    label{display:block;margin-top:10px;font-weight:600}
    input,textarea,button,select{width:100%;padding:10px;margin-top:6px;border:1px solid #e6eefb;border-radius:8px;font-size:14px}
    button.primary{background:#ff6b35;color:#fff;border:0;cursor:pointer;font-weight:800}
    .small{font-size:13px;color:#6b7280;margin-top:8px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tabs button{width:auto;padding:8px 12px;border-radius:8px;background:#f3f7ff;border:1px solid #e6efff;cursor:pointer}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid #f1f1f1;text-align:left}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef7ff;color:#0658d9;font-weight:700}
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="logo">TOOL SMS FREE — Demo</div>
      <div class="admin-info">Zalo Admin: <strong>0869234153</strong></div>
    </header>

    <main>
      <div class="left">
        <div class="card" id="authCard">
          <div class="tabs">
            <button id="tabLogin">Đăng nhập</button>
            <button id="tabRegister">Đăng ký</button>
            <button id="tabTool">Tool</button>
            <button id="tabAdmin">Admin</button>
          </div>

          <div id="boxLogin">
            <h3>Đăng nhập</h3>
            <label>Email</label><input id="loginEmail" type="email" placeholder="you@example.com">
            <label>Mật khẩu</label><input id="loginPassword" type="password" placeholder="••••••">
            <button id="btnLogin" class="primary">Đăng nhập</button>
            <div class="small">Tài khoản admin mặc định: <strong>admin@example.com / admin123</strong> (đổi khi dùng thật)</div>
            <div id="loginMsg" class="small muted"></div>
          </div>

          <div id="boxRegister" class="hidden">
            <h3>Đăng ký</h3>
            <label>Họ tên</label><input id="regName" type="text" placeholder="Họ tên">
            <label>Email</label><input id="regEmail" type="email" placeholder="you@example.com">
            <label>Số điện thoại (tùy chọn)</label><input id="regPhone" type="tel" placeholder="0899...">
            <label>Mật khẩu</label><input id="regPassword" type="password" placeholder="Mật khẩu">
            <button id="btnRegister" class="primary">Đăng ký</button>
            <div id="regMsg" class="small muted"></div>
          </div>

          <div id="boxTool" class="hidden">
            <h3>Gửi SMS (Demo)</h3>
            <label>Số điện thoại</label><input id="phone" type="tel" placeholder="0899...">
            <label>Nội dung</label><textarea id="message" rows="4" placeholder="Nội dung (demo)"></textarea>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="sendDemo" class="primary" style="flex:1">Gửi (Demo)</button>
              <button id="showPhone" style="flex:1">Gọi / Hiện số</button>
            </div>
            <div id="toolMsg" class="small muted"></div>
            <div class="small">Bạn cần đăng nhập để "Gọi / Hiện số" — hành động sẽ được ghi lại và hiển thị cho Admin.</div>
          </div>

          <div id="boxAdmin" class="hidden">
            <h3>Admin Panel</h3>
            <div class="muted">Chỉ admin có thể xem danh sách members & lịch sử click.</div>
            <div style="margin-top:10px">
              <button id="refreshMembers">Tải members</button>
              <button id="refreshActions">Tải actions</button>
            </div>

            <h4 style="margin-top:12px">Members</h4>
            <div id="membersArea" style="max-height:200px;overflow:auto" class="card"></div>

            <h4 style="margin-top:12px">Actions (clicks)</h4>
            <div id="actionsArea" style="max-height:220px;overflow:auto" class="card"></div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h3>Thông tin tài khoản</h3>
          <div id="profileArea">
            <div class="muted">Bạn chưa đăng nhập.</div>
          </div>
          <div style="margin-top:12px"><button id="btnLogout">Đăng xuất</button></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Ghi chú</h4>
          <ul>
            <li class="muted">Mọi thao tác hiện là demo/tracking nội bộ; không gửi SMS thật.</li>
            <li class="muted">Để gửi thật: tích hợp Twilio hoặc Zalo (cần API key & tài khoản)</li>
          </ul>
        </div>
      </div>
    </main>
  </div>

<script>
  // --- UI helpers
  const $ = id => document.getElementById(id);
  const show = id => { $(id).classList.remove('hidden') };
  const hide = id => { $(id).classList.add('hidden') };
  const setMsg = (id,txt,color) => { const el=$(id); el.textContent=txt; el.style.color=color||''; if(!txt) el.style.display='none'; else el.style.display='block'; };

  // Tabs
  const tabs = {login:'boxLogin', register:'boxRegister', tool:'boxTool', admin:'boxAdmin'};
  function openTab(name){
    Object.values(tabs).forEach(id=>hide(id));
    show(tabs[name]);
  }
  $('tabLogin').addEventListener('click', ()=>openTab('login'));
  $('tabRegister').addEventListener('click', ()=>openTab('register'));
  $('tabTool').addEventListener('click', ()=>openTab('tool'));
  $('tabAdmin').addEventListener('click', ()=>openTab('admin'));
  openTab('login');

  // Auth state
  let authToken = localStorage.getItem('sms_token') || null;
  async function apiFetch(path, opts){
    opts = opts || {};
    opts.headers = opts.headers || {};
    opts.headers['Content-Type']='application/json';
    if (authToken) opts.headers['Authorization']='Bearer ' + authToken;
    if (opts.body && typeof opts.body === 'object') opts.body = JSON.stringify(opts.body);
    const res = await fetch(path, opts);
    return res.json();
  }

  async function refreshProfile(){
    if (!authToken) { $('profileArea').innerHTML = '<div class="muted">Bạn chưa đăng nhập.</div>'; return; }
    const res = await apiFetch('/api/profile');
    if (res.ok) {
      $('profileArea').innerHTML = '<div><strong>'+res.user.name+'</strong> <div class="muted">'+res.user.email+'</div><div class="muted">Role: '+res.user.role+'</div></div>';
    } else {
      $('profileArea').innerHTML = '<div class="muted">Phiên hết hạn hoặc lỗi.</div>';
      authToken = null; localStorage.removeItem('sms_token');
    }
  }
  refreshProfile();

  // Register
  $('btnRegister').addEventListener('click', async ()=> {
    const name = $('regName').value.trim();
    const email = $('regEmail').value.trim();
    const phone = $('regPhone').value.trim();
    const password = $('regPassword').value;
    if (!name||!email||!password) { setMsg('regMsg','Vui lòng nhập đủ name / email / password','red'); return; }
    setMsg('regMsg','Đang gửi...','black');
    const res = await apiFetch('/api/register', { method:'POST', body:{ name,email,phone,password } });
    if (res.ok) {
      authToken = res.token; localStorage.setItem('sms_token', authToken);
      setMsg('regMsg','Đăng ký thành công!','green');
      refreshProfile();
      openTab('tool');
    } else {
      setMsg('regMsg',res.error||'Lỗi','red');
    }
  });

  // Login
  $('btnLogin').addEventListener('click', async ()=> {
    const email = $('loginEmail').value.trim();
    const password = $('loginPassword').value;
    if (!email||!password) { setMsg('loginMsg','Vui lòng nhập email & password','red'); return; }
    setMsg('loginMsg','Đang đăng nhập...','black');
    const res = await apiFetch('/api/login', { method:'POST', body:{ email,password } });
    if (res.ok) {
      authToken = res.token; localStorage.setItem('sms_token', authToken);
      setMsg('loginMsg','Đăng nhập thành công!','green');
      refreshProfile();
      openTab('tool');
    } else {
      setMsg('loginMsg', res.error||'Lỗi','red');
    }
  });

  // Logout
  $('btnLogout').addEventListener('click', ()=> {
    authToken = null; localStorage.removeItem('sms_token'); refreshProfile(); setMsg('loginMsg','Đã đăng xuất','black');
  });

  // Tool: demo send
  $('sendDemo').addEventListener('click', async ()=> {
    const phone = $('phone').value.trim();
    const message = $('message').value.trim();
    if (!phone||!message){ setMsg('toolMsg','Nhập phone & nội dung','red'); return; }
    setMsg('toolMsg','Đang gửi (demo)...','black');
    const res = await apiFetch('/api/send-demo', { method:'POST', body:{ phone, message } });
    if (res.ok) setMsg('toolMsg','✅ Demo: đã gửi (không thực) tới ' + res.phone,'green');
    else setMsg('toolMsg',res.error||'Lỗi','red');
  });

  // Tool: show phone / click (record action). Requires login.
  $('showPhone').addEventListener('click', async ()=> {
    const phone = $('phone').value.trim();
    if (!phone){ setMsg('toolMsg','Nhập phone để hiển thị','red'); return; }
    if (!authToken){ setMsg('toolMsg','Bạn cần đăng nhập để ghi lại hành động','red'); return; }
    setMsg('toolMsg','Ghi lại hành động...','black');
    const res = await apiFetch('/api/click', { method:'POST', body:{ phone } });
    if (res.ok) {
      setMsg('toolMsg','✅ Đã ghi lại: ' + phone,'green');
      // show the phone visually (simulate "hiện số")
      alert('Số hiển thị: ' + phone);
    } else {
      setMsg('toolMsg', res.error || 'Lỗi khi ghi lại', 'red');
    }
  });

  // Admin: load members & actions
  async function loadMembers(){
    setMsg('toolMsg','Tải members...','black');
    const res = await apiFetch('/api/members');
    if (res.ok) {
      const membersArea = $('membersArea');
      membersArea.innerHTML = '<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th></tr></thead><tbody>' +
        res.members.map(m=>`<tr><td>${m.name}</td><td>${m.email}</td><td>${m.phone||'<span class="muted">-</span>'}</td><td><span class="pill">${m.role}</span></td></tr>`).join('') +
        '</tbody></table>';
    } else {
      $('membersArea').innerHTML = '<div class="muted">Không thể tải members (' + (res.error||'') + ')</div>';
    }
  }
  async function loadActions(){
    setMsg('toolMsg','Tải actions...','black');
    const res = await apiFetch('/api/actions');
    if (res.ok) {
      const actionsArea = $('actionsArea');
      actionsArea.innerHTML = res.actions.length ? '<table><thead><tr><th>Time</th><th>User</th><th>Phone</th></tr></thead><tbody>' +
        res.actions.map(a=>`<tr><td>${new Date(a.timestamp).toLocaleString()}</td><td>${a.userName} (${a.userId})</td><td>${a.phone}</td></tr>`).join('') +
        '</tbody></table>' : '<div class="muted">Chưa có actions</div>';
    } else {
      $('actionsArea').innerHTML = '<div class="muted">Không thể tải actions ('+(res.error||'')+')</div>';
    }
  }
  $('refreshMembers').addEventListener('click', loadMembers);
  $('refreshActions').addEventListener('click', loadActions);

  // Periodically refresh profile (to show admin panel when logged in as admin)
  setInterval(async ()=> {
    if (authToken) {
      const p = await apiFetch('/api/profile');
      if (p.ok && p.user.role === 'admin') {
        // show admin tab
        $('tabAdmin').style.display = '';
      } else {
        $('tabAdmin').style.display = 'none';
      }
      refreshProfile();
    } else {
      $('tabAdmin').style.display = 'none';
      refreshProfile();
    }
  }, 2000);

  // On load: if token exists, refresh profile and show admin tab if admin
  (async ()=> {
    if (authToken) {
      const p = await apiFetch('/api/profile');
      if (p.ok && p.user.role === 'admin') $('tabAdmin').style.display = '';
      else $('tabAdmin').style.display = 'none';
      refreshProfile();
    } else {
      $('tabAdmin').style.display = 'none';
    }
  })();
</script>
</body>
</html>